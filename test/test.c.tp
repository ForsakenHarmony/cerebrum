
#include <stdint.h>
#include <stdlib.h>
#include <stdio.h>
#define debug_print(...) //fprintf(stderr, __VA_ARGS__)

void ${module_callback("test_multipart", argformat="65B")} (uint16_t payload_offset, uint16_t argsize, uint8_t* args){
    for(unsigned int i=0; i<argsize; i++){
        if(args[i] != 'A'){
            debug_print("Wrong byte in argument buffer for payload_offset %d at position %d. Expected 0x41, got 0x%x\n", payload_offset, i, args[i]);
            exit(1);
        }
    }
    switch(payload_offset){
        case 0:
        case 32:
            if(argsize != ARGBUF_SIZE){
                debug_print("Wrong argument size for payload offset %d. Expected %d, got %d\n", payload_offset, ARGBUF_SIZE, argsize);
                exit(1);
            }
            break;
        case 64:
            if(argsize != 1){
                debug_print("Wrong argument size for payload offset 64. Expected %d, got %d\n", ARGBUF_SIZE, argsize);
                exit(1);
            }
            break;
        default:
            debug_print("Wrong payload_offset: %d\n", payload_offset);
            exit(1);
    }
}

${modulevar("test_buffer", "uint8_t", "65B", array=65)};

void ${module_callback("check_test_buffer")} (uint16_t payload_offset, uint16_t argsize, uint8_t* args){
    for(unsigned int i=0; i<65; i++){
        uint8_t expected = 'A' + (i/32);
        if(${modulevar("test_buffer")}[i] != expected){
            debug_print("Wrong byte in the test buffer at position %d. Expected 0x%x, got 0x%x\n", i, expected, ${modulevar("test_buffer")}[i]);
            exit(1);
        }
    }
}

